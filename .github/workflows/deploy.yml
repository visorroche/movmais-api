name: Deploy API (back.movmais.com) - COM DEBUG

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“ Conectar ao servidor"
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            echo "=========================================="
            echo "ğŸš€ INICIANDO DEPLOY DA API"
            echo "=========================================="
            echo ""

            echo "ğŸ“ Data/Hora do deploy"
            date
            echo ""

            echo "ğŸ“ Verificar diretÃ³rio"
            pwd
            ls -la /opt/movmais/apps/
            echo ""

            echo "ğŸ“ VersÃ£o atual no servidor (ANTES do deploy)"
            cd /opt/movmais/apps/api
            echo "Commit atual:"
            git log -1 --oneline
            echo "Branch:"
            git branch
            echo ""

            echo "ğŸ“ Atualizar cÃ³digo do GitHub"
            git fetch origin
            echo "Commits disponÃ­veis:"
            git log -3 --oneline
            echo ""

            echo "ğŸ“ Fazer reset hard para origin/main"
            git reset --hard origin/main
            echo "âœ… Reset concluÃ­do"
            echo ""

            echo "ğŸ“ VersÃ£o APÃ“S git reset"
            git log -1 --oneline
            echo ""

            echo "ğŸ“ Verificar arquivos alterados"
            git status
            echo ""

            echo "ğŸ“ Verificar conteÃºdo de arquivo importante (package.json)"
            head -5 package.json
            echo ""

                                    echo "=========================================="
            echo "ğŸ“ CRIAR ARQUIVO .ENV DINÃ‚MICO"
            echo "=========================================="
            
            cd /opt/movmais/apps/api
            
            # Criar script temporÃ¡rio para gerar o .env
            cat > generate_env.py << 'PYEOF'
import os

# Mapeamento de secrets passados pelo GitHub
secrets = {
    "PORT": "${{ secrets.PORT }}",
    "CORS_ORIGINS": "${{ secrets.CORS_ORIGINS }}",
    "CORS_HEADERS": "${{ secrets.CORS_HEADERS }}",
    "CORS_METHODS": "${{ secrets.CORS_METHODS }}",
    "DB_HOST": "${{ secrets.DB_HOST }}",
    "DB_PORT": "${{ secrets.DB_PORT }}",
    "DB_USER": "${{ secrets.DB_USER }}",
    "DB_PASS": "${{ secrets.DB_PASS }}",
    "DB_NAME": "${{ secrets.DB_NAME }}",
    "JWT_SECRET": "${{ secrets.JWT_SECRET }}",
    "OPENAI_API_KEY": "${{ secrets.OPENAI_API_KEY }}",
    "SCRIPT_BI_SCHEDULER_URL": "${{ secrets.SCRIPT_BI_SCHEDULER_URL }}",
    "SCRIPT_BI_SCHEDULER_RUN_TOKEN": "${{ secrets.SCRIPT_BI_SCHEDULER_RUN_TOKEN }}"
}

env_content = []
with open(".env.example", "r") as f:
    for line in f:
        line = line.strip()
        if not line or line.startswith("#"):
            env_content.append(line)
            continue
        
        key = line.split("=")[0].strip()
        if key in secrets and secrets[key]:
            env_content.append(f"{key}={secrets[key]}")
        else:
            env_content.append(line)

# Adicionar fixos
env_content.append("NODE_ENV=production")
env_content.append("DB_SSL=true")

with open(".env", "w") as f:
    f.write("
".join(env_content) + "
")

print("âœ… .env gerado com sucesso")
PYEOF
            
            python3 generate_env.py
            rm generate_env.py
            
            echo "âœ… Arquivo .env atualizado dinamicamente"
            echo ""  
            echo ""
            
            # Debug: mostrar variÃ¡veis injetadas
            echo "ğŸ“ VariÃ¡veis no .env:"
            cat /opt/movmais/apps/api/.env
            echo ""

            echo "=========================================="
            echo "ğŸ³ DOCKER BUILD"
            echo "=========================================="
            cd /opt/movmais
            echo ""

            echo "ğŸ“ Remover imagem antiga"
            docker rmi movmais-api -f || echo "Nenhuma imagem anterior"
            echo ""

            echo "ğŸ“ Parar container antigo"
            docker-compose stop api || echo "Container nÃ£o estava rodando"
            echo ""

            echo "ğŸ“ Iniciar build (sem cache)"
            docker-compose build --no-cache api
            BUILD_STATUS=$?

            if [ $BUILD_STATUS -eq 0 ]; then
              echo "âœ… BUILD SUCESSO"
            else
              echo "âŒ BUILD FALHOU"
              exit 1
            fi
            echo ""

            echo "=========================================="
            echo "ğŸš€ INICIAR CONTAINER"
            echo "=========================================="
            docker-compose down api || true
            docker rm movmais-api -f || true
            docker-compose up -d api
            echo ""

            echo "ğŸ“ Aguardar 5 segundos para container iniciar"
            sleep 5
            echo ""

            echo "ğŸ“ Status dos containers"
            docker-compose ps
            echo ""

            echo "ğŸ“ Logs do container (Ãºltimas 30 linhas)"
            docker logs movmais-api | tail -30
            echo ""

            echo "=========================================="
            echo "âœ… VERIFICAÃ‡Ã•ES FINAIS"
            echo "=========================================="

            echo "ğŸ“ Verificar versÃ£o no servidor (APÃ“S deploy)"
            cd /opt/movmais/apps/api
            echo "Commit atual:"
            git log -1 --oneline
            echo ""

            echo "ğŸ“ Verificar se container estÃ¡ rodando"
            docker-compose ps api
            echo ""

            echo "ğŸ“ Testar acesso Ã  API"
            curl -s -I http://127.0.0.1:5003/ | head -3
            echo ""

            echo "ğŸ“ Verificar porta 5003 estÃ¡ aberta"
            netstat -tlnp | grep 5003 || echo "âš ï¸ Porta 5003 nÃ£o encontrada"
            echo ""

            echo "=========================================="
            echo "âœ… DEPLOY CONCLUÃDO COM SUCESSO!"
            echo "=========================================="
            echo "Timestamp: $(date)"
            echo "URL: https://back.movmais.com"
            echo "=========================================="
