name: Deploy API

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '**.txt'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          # N√£o precisamos mais do bloco envs, pois o secret ENV ser√° injetado diretamente no script
          script: |
            echo "=========================================="
            echo "üöÄ INICIANDO DEPLOY DA API"
            echo "=========================================="
            
            cd /opt/movmais/apps/api
            
            echo "=========================================="
            echo "üìù CRIAR ARQUIVO .ENV (SECRET √öNICO)"
            echo "=========================================="
            
            # 1. Escrever o conte√∫do do secret ENV diretamente no arquivo .env
            # O uso de 'EOF' garante que o conte√∫do seja escrito literalmente,
            # incluindo quebras de linha, sem problemas de escape.
            cat << 'EOF' > .env
${{ secrets.ENV }}
EOF
            
            echo "=========================================="
            echo "üîÑ ATUALIZAR C√ìDIGO E REINICIAR CONTAINER"
            echo "=========================================="
            
            # 2. Atualizar o c√≥digo
            git pull
            
            # 3. Parar e remover o container antigo
            docker-compose down api || true
            
            # 4. Reconstruir e subir o container (o build usar√° o novo .env)
            docker-compose up -d --build api
            
            echo "=========================================="
            echo "‚úÖ DEPLOY CONCLU√çDO"
            echo "=========================================="
