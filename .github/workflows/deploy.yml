name: Deploy API (back.movmais.com) - COM DEBUG

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: "üìç Conectar ao servidor"
        uses: appleboy/ssh-action@master
                with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          envs: PORT,CORS_ORIGINS,CORS_HEADERS,CORS_METHODS,DB_HOST,DB_PORT,DB_USER,DB_PASS,DB_NAME,JWT_SECRET,OPENAI_API_KEY,SCRIPT_BI_SCHEDULER_URL,SCRIPT_BI_SCHEDULER_RUN_TOKEN
          script: |
            echo "=========================================="
            echo "üöÄ INICIANDO DEPLOY DA API"
            echo "=========================================="
            echo ""

            echo "üìç Data/Hora do deploy"
            date
            echo ""

            echo "üìç Verificar diret√≥rio"
            pwd
            ls -la /opt/movmais/apps/
            echo ""

            echo "üìç Vers√£o atual no servidor (ANTES do deploy)"
            cd /opt/movmais/apps/api
            echo "Commit atual:"
            git log -1 --oneline
            echo "Branch:"
            git branch
            echo ""

            echo "üìç Atualizar c√≥digo do GitHub"
            git fetch origin
            echo "Commits dispon√≠veis:"
            git log -3 --oneline
            echo ""

            echo "üìç Fazer reset hard para origin/main"
            git reset --hard origin/main
            echo "‚úÖ Reset conclu√≠do"
            echo ""

            echo "üìç Vers√£o AP√ìS git reset"
            git log -1 --oneline
            echo ""

            echo "üìç Verificar arquivos alterados"
            git status
            echo ""

            echo "üìç Verificar conte√∫do de arquivo importante (package.json)"
            head -5 package.json
            echo ""

                                                echo "=========================================="
            echo "üìù CRIAR ARQUIVO .ENV DIN√ÇMICO"
            echo "=========================================="
            
            cd /opt/movmais/apps/api
            
            # Criar .env limpo
            > .env
            
            # Lista de vari√°veis que queremos injetar (devem estar no bloco 'envs' do workflow)
            VARS=("PORT" "CORS_ORIGINS" "CORS_HEADERS" "CORS_METHODS" "DB_HOST" "DB_PORT" "DB_USER" "DB_PASS" "DB_NAME" "JWT_SECRET" "OPENAI_API_KEY" "SCRIPT_BI_SCHEDULER_URL" "SCRIPT_BI_SCHEDULER_RUN_TOKEN")
            
            # Ler .env.example
            while IFS='=' read -r key value || [ -n "$key" ]; do
              # Ignorar coment√°rios e linhas vazias
              if [[ $key =~ ^#.* ]] || [[ -z $key ]]; then
                echo "$key" >> .env
                continue
              fi
              
              var_name=$(echo $key | xargs)
              
              # Verificar se a vari√°vel est√° na nossa lista de inje√ß√£o
              is_secret=false
              for v in "${VARS[@]}"; do
                if [ "$v" == "$var_name" ]; then
                  is_secret=true
                  break
                fi
              done
              
              if [ "$is_secret" = true ]; then
                # Pegar o valor da vari√°vel de ambiente (passada pelo appleboy/ssh-action)
                val=$(eval echo \$$var_name)
                if [ -n "$val" ]; then
                  echo "Injetando $var_name"
                  echo "$var_name=$val" >> .env
                else
                  echo "‚ö†Ô∏è $var_name vazio, usando default"
                  echo "$key=$value" >> .env
                fi
              else
                echo "$key=$value" >> .env
              fi
            done < .env.example
            
            echo "NODE_ENV=production" >> .env
            echo "DB_SSL=true" >> .env
            
            echo "‚úÖ Arquivo .env atualizado dinamicamente"
            echo ""   
            echo ""
            
            # Debug: mostrar vari√°veis injetadas
            echo "üìç Vari√°veis no .env:"
            cat /opt/movmais/apps/api/.env
            echo ""

            echo "=========================================="
            echo "üê≥ DOCKER BUILD"
            echo "=========================================="
            cd /opt/movmais
            echo ""

            echo "üìç Remover imagem antiga"
            docker rmi movmais-api -f || echo "Nenhuma imagem anterior"
            echo ""

            echo "üìç Parar container antigo"
            docker-compose stop api || echo "Container n√£o estava rodando"
            echo ""

            echo "üìç Iniciar build (sem cache)"
            docker-compose build --no-cache api
            BUILD_STATUS=$?

            if [ $BUILD_STATUS -eq 0 ]; then
              echo "‚úÖ BUILD SUCESSO"
            else
              echo "‚ùå BUILD FALHOU"
              exit 1
            fi
            echo ""

            echo "=========================================="
            echo "üöÄ INICIAR CONTAINER"
            echo "=========================================="
            docker-compose down api || true
            docker rm movmais-api -f || true
            docker-compose up -d api
            echo ""

            echo "üìç Aguardar 5 segundos para container iniciar"
            sleep 5
            echo ""

            echo "üìç Status dos containers"
            docker-compose ps
            echo ""

            echo "üìç Logs do container (√∫ltimas 30 linhas)"
            docker logs movmais-api | tail -30
            echo ""

            echo "=========================================="
            echo "‚úÖ VERIFICA√á√ïES FINAIS"
            echo "=========================================="

            echo "üìç Verificar vers√£o no servidor (AP√ìS deploy)"
            cd /opt/movmais/apps/api
            echo "Commit atual:"
            git log -1 --oneline
            echo ""

            echo "üìç Verificar se container est√° rodando"
            docker-compose ps api
            echo ""

            echo "üìç Testar acesso √† API"
            curl -s -I http://127.0.0.1:5003/ | head -3
            echo ""

            echo "üìç Verificar porta 5003 est√° aberta"
            netstat -tlnp | grep 5003 || echo "‚ö†Ô∏è Porta 5003 n√£o encontrada"
            echo ""

            echo "=========================================="
            echo "‚úÖ DEPLOY CONCLU√çDO COM SUCESSO!"
            echo "=========================================="
            echo "Timestamp: $(date)"
            echo "URL: https://back.movmais.com"
            echo "=========================================="
