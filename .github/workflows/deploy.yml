name: Deploy API

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '**.txt'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          envs: PORT,CORS_ORIGINS,CORS_HEADERS,CORS_METHODS,DB_HOST,DB_PORT,DB_USER,DB_PASS,DB_NAME,JWT_SECRET,OPENAI_API_KEY,SCRIPT_BI_SCHEDULER_URL,SCRIPT_BI_SCHEDULER_RUN_TOKEN
          script: |
            echo "=========================================="
            echo "üöÄ INICIANDO DEPLOY DA API"
            echo "=========================================="
            
            cd /opt/movmais/apps/api
            
            echo "=========================================="
            echo "üìù CRIAR ARQUIVO .ENV DIN√ÇMICO"
            echo "=========================================="
            
            # 1. Criar script Python para gerar o .env a partir das vari√°veis de ambiente
            cat << 'PYEOF' > generate_env.py
import os
import re
import sys

# Lista de vari√°veis que queremos injetar
VARS = [
    "PORT", "CORS_ORIGINS", "CORS_HEADERS", "CORS_METHODS", 
    "DB_HOST", "DB_PORT", "DB_USER", "DB_PASS", "DB_NAME", 
    "JWT_SECRET", "OPENAI_API_KEY", 
    "SCRIPT_BI_SCHEDULER_URL", "SCRIPT_BI_SCHEDULER_RUN_TOKEN"
]

def generate_env():
    try:
        with open(".env.example", "r") as f:
            lines = f.readlines()
    except FileNotFoundError:
        print("Erro: .env.example n√£o encontrado. Certifique-se de que o arquivo existe.")
        sys.exit(1)

    output_lines = []
    
    for line in lines:
        if not line.strip() or line.strip().startswith("#"):
            output_lines.append(line.strip())
            continue

        match = re.match(r'^\s*([A-Z_]+)\s*=\s*(.*)$', line)
        if match:
            key = match.group(1)
            val = os.environ.get(key)
            
            if val and key in VARS:
                # Adicionar aspas simples se o valor contiver espa√ßos ou caracteres especiais
                if ' ' in val or '#' in val or '"' in val or "'" in val or ',' in val:
                    injected_line = f"{key}='{val}'"
                else:
                    injected_line = f"{key}={val}"
                output_lines.append(injected_line)
            else:
                output_lines.append(line.strip())
        else:
            output_lines.append(line.strip())

    # Adicionar vari√°veis fixas de produ√ß√£o
    output_lines.append("NODE_ENV=production")
    output_lines.append("DB_SSL=true")
    
    with open(".env", "w") as f:
        f.write("\n".join(output_lines) + "\n")

    print("‚úÖ Arquivo .env atualizado com sucesso.")

if __name__ == "__main__":
    generate_env()
PYEOF
            
            # 2. Executar o script Python
            python3 generate_env.py
            
            # 3. Limpar o script tempor√°rio
            rm generate_env.py
            
            echo "=========================================="
            echo "üîÑ ATUALIZAR C√ìDIGO E REINICIAR CONTAINER"
            echo "=========================================="
            
            # Parar e remover o container antigo
            docker-compose down api || true
            
            # Atualizar o c√≥digo
            git pull
            
            # Reconstruir e subir o container
            docker-compose up -d --build api
            
            echo "=========================================="
            echo "‚úÖ DEPLOY CONCLU√çDO"
            echo "=========================================="
